name: Deploy Web App

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
        default: 'dev'
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'packages/web-app/**'
      - '.github/workflows/deploy-webapp.yml'

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      stage: ${{ steps.set-stage.outputs.stage }}
    steps:
      - name: Determine deployment stage
        id: set-stage
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "stage=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "stage=test" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/feature/* ]]; then
            echo "stage=dev" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
          fi

  build-and-test:
    name: Build and Test Web App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web app
        run: |
          cd packages/web-app
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-app-dist
          path: packages/web-app/dist
          retention-days: 1

  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.stage }}
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-test]
    environment:
      name: ${{ needs.determine-environment.outputs.stage }}
      url: ${{ steps.deploy.outputs.webapp-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-app-dist
          path: packages/web-app/dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          aws sts get-caller-identity
          echo "Deploying web app to: ${{ needs.determine-environment.outputs.stage }}"


      - name: Deploy infrastructure stacks
        env:
          STAGE: ${{ needs.determine-environment.outputs.stage }}
        run: |
          cd packages/infrastructure
          npx cdk deploy --all --require-approval never

      - name: Configure web app
        env:
          STAGE: ${{ needs.determine-environment.outputs.stage }}
        run: |
          chmod +x scripts/configure-webapp.sh
          ./scripts/configure-webapp.sh $STAGE

      - name: Rebuild web app with configuration
        run: |
          cd packages/web-app
          npm run build

      - name: Deploy web app infrastructure
        id: deploy
        env:
          STAGE: ${{ needs.determine-environment.outputs.stage }}
          DEPLOY_WEBAPP: true
        run: |
          cd packages/infrastructure
          npx cdk deploy $STAGE-aws-boilerplate-web-app --require-approval never --outputs-file webapp-outputs.json

          # Extract Web App URL from outputs
          WEBAPP_URL=$(cat webapp-outputs.json | grep -oP '"WebAppUrl":\s*"\K[^"]+' || echo "N/A")
          echo "webapp-url=$WEBAPP_URL" >> $GITHUB_OUTPUT

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        with:
          name: webapp-outputs-${{ needs.determine-environment.outputs.stage }}
          path: packages/infrastructure/webapp-outputs.json
          retention-days: 30

      - name: Deployment summary
        run: |
          echo "## Web App Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully deployed web app to **${{ needs.determine-environment.outputs.stage }}** environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "- Web App URL: [\`${{ steps.deploy.outputs.webapp-url }}\`](${{ steps.deploy.outputs.webapp-url }})" >> $GITHUB_STEP_SUMMARY
          echo "- Region: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Stage: \`${{ needs.determine-environment.outputs.stage }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stack Name" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ needs.determine-environment.outputs.stage }}-aws-boilerplate-web-app\`" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy]
    if: always()
    steps:
      - name: Deployment status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "✅ Web app deployment to ${{ needs.determine-environment.outputs.stage }} succeeded!"
          else
            echo "❌ Web app deployment to ${{ needs.determine-environment.outputs.stage }} failed!"
            exit 1
          fi
