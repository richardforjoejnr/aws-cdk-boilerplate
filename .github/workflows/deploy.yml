name: Deploy to AWS

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop

permissions:
  id-token: write   # Required for OIDC authentication
  contents: read

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      stage: ${{ steps.set-stage.outputs.stage }}
      should-deploy: ${{ steps.set-stage.outputs.should-deploy }}
    steps:
      - name: Determine deployment stage
        id: set-stage
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "stage=test" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/feature/* ]]; then
            echo "stage=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "stage=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "stage=dev" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Build TypeScript
        run: npm run build

  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.stage }}
    runs-on: ubuntu-latest
    needs: [determine-environment, lint-and-test]
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment:
      name: ${{ needs.determine-environment.outputs.stage }}
      url: ${{ steps.deploy.outputs.api-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          aws sts get-caller-identity
          echo "Deploying to environment: ${{ needs.determine-environment.outputs.stage }}"

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Deploy to AWS with Smart Deployment
        id: deploy
        env:
          STAGE: ${{ needs.determine-environment.outputs.stage }}
        run: |
          # Use the smart deployment script
          ./scripts/deploy-with-cleanup.sh $STAGE

          # Read outputs from the generated JSON file
          if [ -f ".deployment-outputs-${STAGE}.json" ]; then
            API_URL=$(cat .deployment-outputs-${STAGE}.json | grep -oP '"apiUrl":\s*"\K[^"]+' || echo "N/A")
            echo "api-url=$API_URL" >> $GITHUB_OUTPUT
          fi

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        with:
          name: deployment-outputs-${{ needs.determine-environment.outputs.stage }}
          path: .deployment-outputs-${{ needs.determine-environment.outputs.stage }}.json
          retention-days: 30
        if: always()

      - name: Validate deployment
        env:
          STAGE: ${{ needs.determine-environment.outputs.stage }}
        run: |
          chmod +x scripts/validate-deployment.sh
          ./scripts/validate-deployment.sh $STAGE || echo "‚ö†Ô∏è Validation had some issues, but deployment completed"

      - name: Deployment summary
        run: |
          STAGE="${{ needs.determine-environment.outputs.stage }}"

          # Read deployment outputs
          if [ -f ".deployment-outputs-${STAGE}.json" ]; then
            TABLE_NAME=$(cat .deployment-outputs-${STAGE}.json | grep -oP '"tableName":\s*"\K[^"]+' || echo "N/A")
            LAMBDA_NAME=$(cat .deployment-outputs-${STAGE}.json | grep -oP '"lambdaName":\s*"\K[^"]+' || echo "N/A")
            API_URL=$(cat .deployment-outputs-${STAGE}.json | grep -oP '"apiUrl":\s*"\K[^"]+' || echo "N/A")
            API_KEY=$(cat .deployment-outputs-${STAGE}.json | grep -oP '"apiKey":\s*"\K[^"]+' || echo "N/A")
            STATE_MACHINE=$(cat .deployment-outputs-${STAGE}.json | grep -oP '"stateMachineArn":\s*"\K[^"]+' || echo "N/A")
          fi

          echo "## Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Successfully deployed to **${STAGE}** environment with smart deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **DynamoDB Table:** \`${TABLE_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Lambda Function:** \`${LAMBDA_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GraphQL API URL:** \`${API_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GraphQL API Key:** \`${API_KEY}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **State Machine:** \`${STATE_MACHINE}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stack Names" >> $GITHUB_STEP_SUMMARY
          echo "- \`${STAGE}-aws-boilerplate-database\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${STAGE}-aws-boilerplate-lambda\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${STAGE}-aws-boilerplate-appsync\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${STAGE}-aws-boilerplate-step-functions\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What Changed üéØ" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Automatic cleanup of orphaned resources" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Failed stack detection and removal" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Deployment validation performed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Complete deployment outputs saved" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy]
    if: always() && needs.determine-environment.outputs.should-deploy == 'true'
    steps:
      - name: Deployment status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ Deployment to ${{ needs.determine-environment.outputs.stage }} succeeded!"
          else
            echo "‚ùå Deployment to ${{ needs.determine-environment.outputs.stage }} failed!"
            exit 1
          fi
